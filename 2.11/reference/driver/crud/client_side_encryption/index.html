<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="">
<meta name="keyword" content="">

    <link rel="shortcut icon" href="/mongo-csharp-driver/2.11/img/favicon.png">

    <title>Client-Side Encryption</title>

    <link rel="stylesheet" href="/mongo-csharp-driver/2.11/lib/bootstrap.css" type="text/css" />
<link rel="stylesheet" href="/mongo-csharp-driver/2.11/lib/font-awesome/css/font-awesome.min.css" type="text/css" />
<link rel="stylesheet" href="/mongo-csharp-driver/2.11/css/mongodb-docs.css" type="text/css" />
<link rel="stylesheet" href="/mongo-csharp-driver/2.11/css/overrides.css" type="text/css" />
<link rel="stylesheet" href="/mongo-csharp-driver/2.11/lib/highlight/styles/idea.css" />
<link rel="stylesheet" href="/mongo-csharp-driver/2.11/lib/bootstrap-toggle/bootstrap-toggle.min.css" type="text/css" />
<link rel="stylesheet" href="/mongo-csharp-driver/2.11/css/dn.css" type="text/css" />


  </head>

  <body>
  
  <section id="container" class="">
      
      <header id="header-db" class="row" role="navigation">
  <div class="header-content">
    <div class="toggle-nav pull-left">
        <i class="fa fa-bars"></i>
        <div class="icon-reorder tooltips" data-original-title="Toggle Navigation" data-placement="bottom"></div>
    </div>
    
    <div class="logo pull-left">
      <a href="/mongo-csharp-driver/2.11/../">
        <img src="/mongo-csharp-driver/2.11/img/logo-mongodb-header.png", alt="MongoDB.org" />
      </a>
    </div>
    
    <div>
<div class="nav-items pull-right">
  <a href="http://try.mongodb.org/" data-toggle="tooltip" data-placement="bottom" title="Try MongoDB in the browser">Try it Out</a>
  <a href="http://www.mongodb.org/downloads" data-toggle="tooltip" data-placement="bottom" title="Download MongoDB">Downloads</a>
  <a href="http://www.mongodb.org/get-involved" data-toggle="tooltip" data-placement="bottom" title="Get involved with MongoDB">Community</a>
  <a href="http://docs.mongodb.org" data-toggle="tooltip" data-placement="bottom" title="The MongoDB Documentation">Docs</a>
  <a href="http://blog.mongodb.org" data-toggle="tooltip" data-placement="bottom" title="The MongoDB Blog">Blog</a>
  <div id="search">
<form method="get" action="//www.google.com/search" target="_blank">
    <input type="text" name="searchQuery" size="20" value="" autocomplete="off" placeholder="Search docs">
    <input type="hidden" name="site" value="/mongo-csharp-driver/2.11">
    <input type="hidden" name="q" value="">
    <label for="searchQuery"><i class="fa fa-search fa-1"></i></label>
</form>
</div>

</div>
</div>

  </div>
</header>

      

      
<aside id="sidebar" class="sidebar">
    <div class="ssidebar nav-collapse">
      <div class="ssidebarwrapper">
        <h3>
          <a class="index-link" href="/mongo-csharp-driver/2.11/../">MongoDB .NET Driver</a>
          <a class="version pull-right" href="/mongo-csharp-driver/2.11">2.11</a>
        </h3>

        
        <ul class="sidebar-menu">
          
          
          
          
          
          
          
          
          
          
          
          

          
          
            
            









  
    
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
    
      
    
  


          
            
            









  
    
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
    
      
    
  


          
            
            









  
    
    
      
      
        
        
        
        
        
        
        
        









  
    
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  
    
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
    
      
    
  


        
          
        
      
    
    
      
    
  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  
    
    
      
      
        
        
        
        
        
        
        
        









  
    
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
    
      
    
  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  
    
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
    
      
    
  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  
    
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  
  
  
  
  
  
  
  

  
    
    
    
      
      
      
        
        
        
          
        
      
      
    
    
  
  


        
      
    
    
  


        
      
    
      
      
        
      
    
      
      
    
    
  


        
      
    
      
      
    
      
      
    
    
  


          
            
            









  
    
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
    
  


          
            
            









  


          
            
            









  


          
            
            









  


          

          

          
            
            
















<li class="toctree-l1 ">
  <a href="/mongo-csharp-driver/2.11/getting_started/" class="">
      <i class='fa fa-road'></i>
      <span>Getting Started</span>
      <span class="menu-arrow fa fa-angle-right"></span>
  </a>
    <ul >
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongo-csharp-driver/2.11/getting_started/installation/">
        <i class='fa'></i>
        Installation
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongo-csharp-driver/2.11/getting_started/quick_tour/">
        <i class='fa'></i>
        Quick Tour
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongo-csharp-driver/2.11/getting_started/admin_quick_tour/">
        <i class='fa'></i>
        Admin Quick Tour
    </a>
  </li>


        
        
    </ul>
  </li>


          
            
            
















<li class="toctree-l1 ">
  <a href="/mongo-csharp-driver/2.11/what_is_new/" class="">
      <i class='fa fa-star'></i>
      <span>What&#39;s New</span>
      <span class="menu-arrow fa fa-angle-right"></span>
  </a>
    <ul >
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongo-csharp-driver/2.11/upgrading/">
        <i class='fa'></i>
        Upgrading
    </a>
  </li>


        
        
    </ul>
  </li>


          
            
            













  




<li class="toctree-l1  current">
  <a href="/mongo-csharp-driver/2.11/reference/" class="">
      <i class='fa fa-book'></i>
      <span>Reference</span>
      <span class="menu-arrow fa fa-angle-down"></span>
  </a>
    <ul  class="current">
        
        
        
        
















<li class="toctree-l2 ">
  <a href="/mongo-csharp-driver/2.11/reference/bson/" class="">
      <i class='fa'></i>
      <span>BSON</span>
      
  </a>
    <ul >
        
        
        
        
















    <li class="toctree-l3">
    <a href="/mongo-csharp-driver/2.11/reference/bson/bson/">
        <i class='fa'></i>
        BSON/JSON
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l3">
    <a href="/mongo-csharp-driver/2.11/reference/bson/bson_document/">
        <i class='fa'></i>
        BsonDocument
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l3">
    <a href="/mongo-csharp-driver/2.11/reference/bson/serialization/">
        <i class='fa'></i>
        Serialization
    </a>
  </li>


        
        
        
        
        
















<li class="toctree-l3 ">
  <a href="/mongo-csharp-driver/2.11/reference/bson/mapping/" class="">
      <i class='fa'></i>
      <span>Mapping Classes</span>
      
  </a>
    <ul >
        
        
        
        
















    <li class="toctree-l4">
    <a href="/mongo-csharp-driver/2.11/reference/bson/mapping/polymorphism/">
        <i class='fa'></i>
        Polymorphism
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l4">
    <a href="/mongo-csharp-driver/2.11/reference/bson/mapping/conventions/">
        <i class='fa'></i>
        Conventions
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l4">
    <a href="/mongo-csharp-driver/2.11/reference/bson/mapping/schema_changes/">
        <i class='fa'></i>
        Handling Schema Changes
    </a>
  </li>


        
        
    </ul>
  </li>


        
        
    </ul>
  </li>


        
        
        
        
        













  




<li class="toctree-l2  current">
  <a href="/mongo-csharp-driver/2.11/reference/driver/" class="">
      <i class='fa'></i>
      <span>Driver</span>
      
  </a>
    <ul  class="current">
        
        
        
        
















<li class="toctree-l3 ">
  <a href="/mongo-csharp-driver/2.11/reference/driver/connecting/" class="">
      <i class='fa'></i>
      <span>Connecting</span>
      
  </a>
    <ul >
        
        
        
        
















    <li class="toctree-l4">
    <a href="/mongo-csharp-driver/2.11/reference/driver/ssl/">
        <i class='fa'></i>
        SSL
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l4">
    <a href="/mongo-csharp-driver/2.11/reference/driver/authentication/">
        <i class='fa'></i>
        Authentication
    </a>
  </li>


        
        
    </ul>
  </li>


        
        
        
        
        
















<li class="toctree-l3 ">
  <a href="/mongo-csharp-driver/2.11/reference/driver/definitions/" class="">
      <i class='fa'></i>
      <span>Definitions and Builders</span>
      
  </a>
    <ul >
        
        
        
        
















    <li class="toctree-l4">
    <a href="/mongo-csharp-driver/2.11/reference/driver/expressions/">
        <i class='fa'></i>
        Expressions
    </a>
  </li>


        
        
    </ul>
  </li>


        
        
        
        
        
















    <li class="toctree-l3">
    <a href="/mongo-csharp-driver/2.11/reference/driver/admin/">
        <i class='fa'></i>
        Administration
    </a>
  </li>


        
        
        
        
        













  




<li class="toctree-l3  current">
  <a href="/mongo-csharp-driver/2.11/reference/driver/crud/" class="">
      <i class='fa'></i>
      <span>Reading and Writing</span>
      
  </a>
    <ul  class="current">
        
        
        
        
















    <li class="toctree-l4">
    <a href="/mongo-csharp-driver/2.11/reference/driver/crud/reading/">
        <i class='fa'></i>
        Reading
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l4">
    <a href="/mongo-csharp-driver/2.11/reference/driver/crud/linq/">
        <i class='fa'></i>
        LINQ
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l4">
    <a href="/mongo-csharp-driver/2.11/reference/driver/crud/writing/">
        <i class='fa'></i>
        Writing
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l4">
    <a href="/mongo-csharp-driver/2.11/reference/driver/crud/compression/">
        <i class='fa'></i>
        Compression
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l4">
    <a href="/mongo-csharp-driver/2.11/reference/driver/crud/sessions_and_transactions/">
        <i class='fa'></i>
        Sessions and Transactions
    </a>
  </li>


        
        
        
        
        













  




    <li class="toctree-l4">
    <a href="/mongo-csharp-driver/2.11/reference/driver/crud/client_side_encryption/">
        <i class='fa fa-lock'></i>
        Client-Side Encryption
    </a>
  </li>


        
        
    </ul>
  </li>


        
        
        
        
        
















    <li class="toctree-l3">
    <a href="/mongo-csharp-driver/2.11/reference/driver/change_streams/">
        <i class='fa'></i>
        Change Streams
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l3">
    <a href="/mongo-csharp-driver/2.11/reference/driver/error_handling/">
        <i class='fa'></i>
        Error Handling
    </a>
  </li>


        
        
    </ul>
  </li>


        
        
        
        
        
















<li class="toctree-l2 ">
  <a href="/mongo-csharp-driver/2.11/reference/driver_core/" class="">
      <i class='fa'></i>
      <span>Driver Core</span>
      
  </a>
    <ul >
        
        
        
        
















<li class="toctree-l3 ">
  <a href="/mongo-csharp-driver/2.11/reference/driver_core/events/" class="">
      <i class='fa'></i>
      <span>Eventing</span>
      
  </a>
    <ul >
        
        
        
        
















    <li class="toctree-l4">
    <a href="/mongo-csharp-driver/2.11/reference/driver_core/sdamevents/">
        <i class='fa'></i>
        SDAM Events
    </a>
  </li>


        
        
    </ul>
  </li>


        
        
    </ul>
  </li>


        
        
        
        
        
















<li class="toctree-l2 ">
  <a href="/mongo-csharp-driver/2.11/reference/gridfs/" class="">
      <i class='fa'></i>
      <span>GridFS</span>
      
  </a>
    <ul >
        
        
        
        
















    <li class="toctree-l3">
    <a href="/mongo-csharp-driver/2.11/reference/gridfs/gettingstarted/">
        <i class='fa'></i>
        Getting Started
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l3">
    <a href="/mongo-csharp-driver/2.11/reference/gridfs/uploadingfiles/">
        <i class='fa'></i>
        Uploading Files
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l3">
    <a href="/mongo-csharp-driver/2.11/reference/gridfs/downloadingfiles/">
        <i class='fa'></i>
        Downloading Files
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l3">
    <a href="/mongo-csharp-driver/2.11/reference/gridfs/findingfiles/">
        <i class='fa'></i>
        Finding Files
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l3">
    <a href="/mongo-csharp-driver/2.11/reference/gridfs/deletingandrenamingfiles/">
        <i class='fa'></i>
        Deleting and Renaming Files
    </a>
  </li>


        
        
    </ul>
  </li>


        
        
    </ul>
  </li>


          
            
            
















<li class="toctree-l1 ">
  <a href="/mongo-csharp-driver/2.11/examples/" class="">
      <i class='fa fa-code'></i>
      <span>Examples</span>
      <span class="menu-arrow fa fa-angle-right"></span>
  </a>
    <ul >
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongo-csharp-driver/2.11/examples/exporting_json/">
        <i class='fa'></i>
        Exporting JSON
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongo-csharp-driver/2.11/examples/importing_json/">
        <i class='fa'></i>
        Importing JSON
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongo-csharp-driver/2.11/examples/mixing_static_and_dynamic/">
        <i class='fa'></i>
        Mixing Static and Dynamic Data
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongo-csharp-driver/2.11/examples/tailable_cursor/">
        <i class='fa'></i>
        Using a Tailable Cursor
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongo-csharp-driver/2.11/examples/user_management/">
        <i class='fa'></i>
        Managing Users
    </a>
  </li>


        
        
    </ul>
  </li>


          
            
            
















    <li class="toctree-l1">
    <a href="/mongo-csharp-driver/2.11/apidocs/">
        <i class='fa fa-file-text-o'></i>
        API Documentation
    </a>
  </li>


          
            
            
















    <li class="toctree-l1">
    <a href="https://github.com/mongodb/mongo-csharp-driver/tree/master">
        <i class='fa fa-github'></i>
        Source Code
    </a>
  </li>


          
            
            
















    <li class="toctree-l1">
    <a href="/mongo-csharp-driver/2.11/issues_help/">
        <i class='fa fa-life-ring'></i>
        Issues &amp; Help
    </a>
  </li>


          
        </ul>
        
    </div>
  </div>
  
</aside>

<div class="option-popup closed hidden" id="optionsVersionsPopup">
<div class="option-header">
  <i class="fa fa-gear"></i>
  <span>OPTIONS</span>
  <i class="fa fa-angle-up pull-right"></i>
</div>
<div class="option-body">
  <ul>
      
      <li>
        <label>Version</label>
        <div class="btn-group btn-group-xs pull-right">
          <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
            Select Version <span class="caret"></span>
          </button>
          <ul class="dropdown-menu" role="menu" id="optionsVersionsMenu">
          </ul>
        </div>
      </li>

   


    

  </ul>
</div>
</div>



      
      <section id="main-content" class="content">
          <section class="main-column pull-left">
            <div class="document">
              <div class="documentwrapper">
                <div class="bodywrapper">
                  <div class="body">


   
<a class="edit-link" href="https://github.com/mongodb/mongo-csharp-driver/blob/master/docs/reference/content/reference%5cdriver%5ccrud%5cclient_side_encryption.md" target="_blank" title="Edit reference\driver\crud\client_side_encryption.md on GitHub"><i class="fa fa-pencil-square-o"></i></a>










<div class="bc">
<ul>
  
  
  
  <li><a href="/mongo-csharp-driver/2.11/reference/">Reference</a> <i class="fa fa-angle-right"></i></li>
  <li><a href="/mongo-csharp-driver/2.11/reference/driver/">Driver</a> <i class="fa fa-angle-right"></i></li>
  <li><a href="/mongo-csharp-driver/2.11/reference/driver/crud/">Reading and Writing</a> <i class="fa fa-angle-right"></i></li>
  <li>Client-Side Encryption</li>
</ul>
</div>




<h1 id="client-side-field-level-encryption">Client-Side Field Level Encryption</h1>

<p>New in MongoDB 4.2, client-side field level encryption allows administrators and
developers to encrypt specific data fields in addition to other MongoDB
encryption features.</p>

<p>With client-side field level encryption, developers can encrypt fields
client-side without any server-side configuration or directives. Client-side
field level encryption supports workloads where applications must guarantee that
unauthorized parties, including server administrators, cannot read the encrypted
data.</p>

<p><div class="admonition important">
<h5 class="admonition-title">important</h5>
<p>Client-side field level encryption is supported only on Windows.</p>

</div>
</p>

<h2 id="mongocryptd-configuration">mongocryptd configuration</h2>

<p>Client-side field level encryption requires the <code>mongocryptd</code> daemon / process
to be running. If <code>mongocryptd</code> isn&rsquo;t running, the driver will atempt to spawn
an instance, utilizing the <code>PATH</code> environment variable. Alternatively, the path
to <code>mongocryptd</code> can be specified by setting <code>mongocryptdSpawnPath</code> in
<code>extraOptions</code>. A specific daemon / process URI can also be configured in the
<code>AutoEncryptionSettings</code> class by setting <code>mongocryptdURI</code> in <code>extraOptions</code>.</p>

<p>More information about <code>mongocryptd</code> will soon be available from the official
documentation.</p>

<h2 id="examples">Examples</h2>

<h3 id="automatic-client-side-encryption">Automatic client-side encryption</h3>

<p>The following is a sample app that assumes the <strong>key</strong> and <strong>schema</strong> have
already been created in MongoDB. The example uses a local key, however using AWS
Key Management Service is also an option. The data in the <code>encryptedField</code> field
is automatically encrypted on the insert and decrypted when using find on the
client-side. The following example has been adapted from
<a href="https://github.com/mongodb/mongo-csharp-driver/blob/master/tests/MongoDB.Driver.Examples/ClientEncryptionExamples.cs"><code>ClientSideEncryptionExamples.cs</code></a>, which can be found on GitHub along with the driver source.</p>

<pre><code class="language-csharp">using System;
using System.Collections.Generic;
using MongoDB.Bson;
using MongoDB.Driver.Encryption;

namespace MongoDB.Driver.Examples
{
    public class ClientEncryptionExamples
    {
        private const string LocalMasterKey = &quot;Mng0NCt4ZHVUYUJCa1kxNkVyNUR1QURhZ2h2UzR2d2RrZzh0cFBwM3R6NmdWMDFBMUN3YkQ5aXRRMkhGRGdQV09wOGVNYUMxT2k3NjZKelhaQmRCZGJkTXVyZG9uSjFk&quot;;

        public static void Main(string[] args)
        {
            var localMasterKey = Convert.FromBase64String(LocalMasterKey);

            var kmsProviders = new Dictionary&lt;string, IReadOnlyDictionary&lt;string, object&gt;&gt;();
            var localKey = new Dictionary&lt;string, object&gt;
            {
                { &quot;key&quot;, localMasterKey }
            };
            kmsProviders.Add(&quot;local&quot;, localKey);

            var keyVaultNamespace = CollectionNamespace.FromFullName(&quot;admin.datakeys&quot;);
            var autoEncryptionOptions = new AutoEncryptionOptions(keyVaultNamespace, kmsProviders);

            var mongoClientSettings = new MongoClientSettings
            {
                AutoEncryptionOptions = autoEncryptionOptions
            };
            var client = new MongoClient(mongoClientSettings);
            var database = client.GetDatabase(&quot;test&quot;);
            database.DropCollection(&quot;coll&quot;);
            var collection = database.GetCollection&lt;BsonDocument&gt;(&quot;coll&quot;);

            collection.InsertOne(new BsonDocument(&quot;encryptedField&quot;, &quot;123456789&quot;));

            var result = collection.Find(FilterDefinition&lt;BsonDocument&gt;.Empty).First();
            Console.WriteLine(result.ToJson());
        }
    }
}
</code></pre>

<p><div class="admonition note">
<h5 class="admonition-title">Note</h5>
<p>Auto encryption is an <strong>enterprise</strong> only feature.</p>

</div>
</p>

<p>The following example shows how to configure the <code>AutoEncryptionSettings</code>
instance to create a new key and how to set the json schema map. The following
example has been adapted from
<a href="https://github.com/mongodb/mongo-csharp-driver/blob/master/tests/MongoDB.Driver.Examples/ClientEncryptionExamples.cs"><code>ClientSideEncryptionExamples.cs</code></a>,
which can be found on Github along with the driver source.</p>

<pre><code class="language-csharp">using System;
using System.Collections.Generic;
using System.Threading;
using MongoDB.Bson;
using MongoDB.Driver.Encryption;

namespace MongoDB.Driver.Examples
{
    public class ClientEncryptionExamples
    {
        private const string LocalMasterKey = &quot;Mng0NCt4ZHVUYUJCa1kxNkVyNUR1QURhZ2h2UzR2d2RrZzh0cFBwM3R6NmdWMDFBMUN3YkQ5aXRRMkhGRGdQV09wOGVNYUMxT2k3NjZKelhaQmRCZGJkTXVyZG9uSjFk&quot;;

        public static void Main(string[] args)
        {
            var localMasterKey = Convert.FromBase64String(LocalMasterKey);

            var kmsProviders = new Dictionary&lt;string, IReadOnlyDictionary&lt;string, object&gt;&gt;();
            var localKey = new Dictionary&lt;string, object&gt;
            {
                { &quot;key&quot;, localMasterKey }
            };
            kmsProviders.Add(&quot;local&quot;, localKey);

            var keyVaultNamespace = CollectionNamespace.FromFullName(&quot;admin.datakeys&quot;);
            var keyVaultMongoClient = new MongoClient();
            var clientEncryptionSettings = new ClientEncryptionOptions(
                keyVaultMongoClient,
                keyVaultNamespace,
                kmsProviders);

            Guid dataKeyId;
            using (var clientEncryption = new ClientEncryption(clientEncryptionSettings))
            {
                dataKeyId = clientEncryption.CreateDataKey(&quot;local&quot;, new DataKeyOptions(), CancellationToken.None);
            }

            var base64DataKeyId = Convert.ToBase64String(GuidConverter.ToBytes(dataKeyId, GuidRepresentation.Standard));
            var collectionNamespace = CollectionNamespace.FromFullName(&quot;test.coll&quot;);

            var schemaMap = $@&quot;{{
                properties: {{
                    encryptedField: {{
                        encrypt: {{
                            keyId: [{{
                                '$binary' : {{
                                    'base64' : '{base64DataKeyId}',
                                    'subType' : '04'
                                }}
                            }}],
                        bsonType: 'string',
                        algorithm: 'AEAD_AES_256_CBC_HMAC_SHA_512-Deterministic'
                        }}
                    }}
                }},
                'bsonType': 'object'
            }}&quot;;
            var autoEncryptionSettings = new AutoEncryptionOptions(
                keyVaultNamespace,
                kmsProviders,
                schemaMap: new Dictionary&lt;string, BsonDocument&gt;()
                {
                    { collectionNamespace.ToString(), BsonDocument.Parse(schemaMap) }
                });
            var clientSettings = new MongoClientSettings
            {
                AutoEncryptionOptions = autoEncryptionSettings
            };
            var client = new MongoClient(clientSettings);
            var database = client.GetDatabase(&quot;test&quot;);
            database.DropCollection(&quot;coll&quot;);
            var collection = database.GetCollection&lt;BsonDocument&gt;(&quot;coll&quot;);

            collection.InsertOne(new BsonDocument(&quot;encryptedField&quot;, &quot;123456789&quot;));

            var result = collection.Find(FilterDefinition&lt;BsonDocument&gt;.Empty).First();
            Console.WriteLine(result.ToJson());
        }
    }
}
</code></pre>

<h3 id="explicit-encryption-and-decryption">Explicit Encryption and Decryption</h3>

<p>Explicit encryption and decryption is a <strong>MongoDB Community Server</strong> feature and does not use the <code>mongocryptd</code> process. Explicit encryption is provided by the <code>ClientEncryption</code> class. The following example has been adapted from <a href="https://github.com/mongodb/mongo-csharp-driver/blob/master/tests/MongoDB.Driver.Examples/ExplicitEncryptionExamples.cs"><code>ExplicitEncryptionExamples.cs</code></a>:</p>

<pre><code class="language-csharp">using System;
using System.Collections.Generic;
using System.Threading;
using MongoDB.Driver.Encryption;
using MongoDB.Libmongocrypt;

namespace MongoDB.Driver.Examples
{
    public class ExplicitEncryptionExamples
    {
        private const string LocalMasterKey = &quot;Mng0NCt4ZHVUYUJCa1kxNkVyNUR1QURhZ2h2UzR2d2RrZzh0cFBwM3R6NmdWMDFBMUN3YkQ5aXRRMkhGRGdQV09wOGVNYUMxT2k3NjZKelhaQmRCZGJkTXVyZG9uSjFk&quot;;

        public static void Main(string[] args)
        {
            var localMasterKey = Convert.FromBase64String(LocalMasterKey);
            var kmsProviders = new Dictionary&lt;string, IReadOnlyDictionary&lt;string, object&gt;&gt;();
            var localKey = new Dictionary&lt;string, object&gt;
            {
                { &quot;key&quot;, localMasterKey }
            };
            kmsProviders.Add(&quot;local&quot;, localKey);

            var keyVaultNamespace = CollectionNamespace.FromFullName(&quot;admin.datakeys&quot;);
            var keyVaultClient = new MongoClient(&quot;mongodb://localhost&quot;);
            var keyVaultDatabase = keyVaultClient.GetDatabase(keyVaultNamespace.DatabaseNamespace.DatabaseName);
            keyVaultDatabase.DropCollection(keyVaultNamespace.CollectionName);

            // Create the ClientEncryption instance
            var clientEncryptionSettings = new ClientEncryptionOptions(
                keyVaultClient,
                keyVaultNamespace,
                kmsProviders);
            using (var clientEncryption = new ClientEncryption(clientEncryptionSettings))
            {
                var dataKeyId = clientEncryption.CreateDataKey(
                    &quot;local&quot;,
                    new DataKeyOptions(),
                    CancellationToken.None);

                var originalString = &quot;123456789&quot;;
                Console.WriteLine($&quot;Original string {originalString}.&quot;);

                // Explicitly encrypt a field
                var encryptOptions = new EncryptOptions(
                    EncryptionAlgorithm.AEAD_AES_256_CBC_HMAC_SHA_512_Deterministic.ToString(),
                    keyId: dataKeyId);
                var encryptedFieldValue = clientEncryption.Encrypt(
                    originalString,
                    encryptOptions,
                    CancellationToken.None);
                Console.WriteLine($&quot;Encrypted value {encryptedFieldValue}.&quot;);

                // Explicitly decrypt the field
                var decryptedValue = clientEncryption.Decrypt(encryptedFieldValue, CancellationToken.None);
                Console.WriteLine($&quot;Decrypted value {decryptedValue}.&quot;);
            }
        }
    }
}
</code></pre>

<h3 id="explicit-encryption-and-auto-decryption">Explicit Encryption and Auto Decryption</h3>

<p>Although automatic encryption requires MongoDB 4.2 Enterprise Server or a MongoDB 4.2 Atlas cluster, automatic decryption is supported for all users. To configure automatic decryption without automatic encryption set <code>bypassAutoEncryption=true</code>. The following example has been adapted from <a href="https://github.com/mongodb/mongo-csharp-driver/blob/master/tests/MongoDB.Driver.Examples/ExplicitEncryptionExamples.cs"><code>ExplicitEncryptionExamples.cs</code></a>:</p>

<pre><code class="language-csharp">using System;
using System.Collections.Generic;
using System.Threading;
using MongoDB.Bson;
using MongoDB.Driver.Encryption;
using MongoDB.Libmongocrypt;

namespace MongoDB.Driver.Examples
{
    public class ExplicitEncryptionAndAutoDecryptionExamples
    {
        private const string LocalMasterKey = &quot;Mng0NCt4ZHVUYUJCa1kxNkVyNUR1QURhZ2h2UzR2d2RrZzh0cFBwM3R6NmdWMDFBMUN3YkQ5aXRRMkhGRGdQV09wOGVNYUMxT2k3NjZKelhaQmRCZGJkTXVyZG9uSjFk&quot;;

        public static void Main(string[] args)
        {
            var localMasterKey = Convert.FromBase64String(LocalMasterKey);
            var kmsProviders = new Dictionary&lt;string, IReadOnlyDictionary&lt;string, object&gt;&gt;();
            var localKey = new Dictionary&lt;string, object&gt;
            {
                { &quot;key&quot;, localMasterKey }
            };
            kmsProviders.Add(&quot;local&quot;, localKey);

            var keyVaultNamespace = CollectionNamespace.FromFullName(&quot;admin.datakeys&quot;);
            var collectionNamespace = CollectionNamespace.FromFullName(&quot;test.coll&quot;);
            var autoEncryptionOptions = new AutoEncryptionOptions(
                keyVaultNamespace,
                kmsProviders,
                bypassAutoEncryption: true);
            var clientSettings = MongoClientSettings.FromConnectionString(&quot;mongodb://localhost&quot;);
            clientSettings.AutoEncryptionOptions = autoEncryptionOptions;
            var mongoClient = new MongoClient(clientSettings);
            var database = mongoClient.GetDatabase(collectionNamespace.DatabaseNamespace.DatabaseName);
            database.DropCollection(collectionNamespace.CollectionName);
            var collection = database.GetCollection&lt;BsonDocument&gt;(collectionNamespace.CollectionName);

            var keyVaultClient = new MongoClient(&quot;mongodb://localhost&quot;);
            var keyVaultDatabase = keyVaultClient.GetDatabase(keyVaultNamespace.DatabaseNamespace.DatabaseName);
            keyVaultDatabase.DropCollection(keyVaultNamespace.CollectionName);

            // Create the ClientEncryption instance
            var clientEncryptionSettings = new ClientEncryptionOptions(
                keyVaultClient,
                keyVaultNamespace,
                kmsProviders);
            using (var clientEncryption = new ClientEncryption(clientEncryptionSettings))
            {
                var dataKeyId = clientEncryption.CreateDataKey(
                    &quot;local&quot;,
                    new DataKeyOptions(),
                    CancellationToken.None);

                var originalString = &quot;123456789&quot;;
                Console.WriteLine($&quot;Original string {originalString}.&quot;);

                // Explicitly encrypt a field
                var encryptOptions = new EncryptOptions(
                    EncryptionAlgorithm.AEAD_AES_256_CBC_HMAC_SHA_512_Deterministic.ToString(),
                    keyId: dataKeyId);
                var encryptedFieldValue = clientEncryption.Encrypt(
                    originalString,
                    encryptOptions,
                    CancellationToken.None);
                Console.WriteLine($&quot;Encrypted value {encryptedFieldValue}.&quot;);

                collection.InsertOne(new BsonDocument(&quot;encryptedField&quot;, encryptedFieldValue));

                // Automatically decrypts the encrypted field.
                var decryptedValue = collection.Find(FilterDefinition&lt;BsonDocument&gt;.Empty).First();
                Console.WriteLine($&quot;Decrypted document {decryptedValue.ToJson()}.&quot;);
            }
        }
    }
}
</code></pre>






<div id="btnv">
  
  <div class="pull-left">
  <a class="navigation prev" href="/mongo-csharp-driver/2.11/reference/driver/crud/sessions_and_transactions/">
      <i class="fa fa-long-arrow-left"> </i> Sessions and Transactions
  </a>
  </div>
  
  
  <div class="pull-right">
  <a class="navigation next" href="/mongo-csharp-driver/2.11/reference/driver/change_streams/">
    Change Streams <i class="fa fa-long-arrow-right"> </i>
  </a>
  
</div>
</div>


</div>
<div class="right-column">
<div class="wrapper">
  
  <div class="toc">
    <span class="toc-header">On this page</span>
    <nav id="TableOfContents">
<ul>
<li><a href="#client-side-field-level-encryption">Client-Side Field Level Encryption</a>
<ul>
<li><a href="#mongocryptd-configuration">mongocryptd configuration</a></li>
<li><a href="#examples">Examples</a>
<ul>
<li><a href="#automatic-client-side-encryption">Automatic client-side encryption</a></li>
<li><a href="#explicit-encryption-and-decryption">Explicit Encryption and Decryption</a></li>
<li><a href="#explicit-encryption-and-auto-decryption">Explicit Encryption and Auto Decryption</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
  
</div>
</div>

</div>
</div>
</div>
</section>
</section>

</section>


<script type="text/javascript">
  var DOCUMENTATION_OPTIONS = {
   URL_ROOT:    "/mongo-csharp-driver/2.11",
   VERSION:     "2.11",
   COLLAPSE_INDEX: false,
   FILE_SUFFIX: '.html',
   HAS_SOURCE:  true
  };
</script>
<script type="text/javascript" src="/mongo-csharp-driver/2.11/js/jquery.js"></script>
<script type="text/javascript" src="/mongo-csharp-driver/2.11/lib/bootstrap.js"></script>
<script type="text/javascript" src="/mongo-csharp-driver/2.11/js/navbar.js"></script>
<script type="text/javascript" src="/mongo-csharp-driver/2.11/lib/highlight/highlight.pack.js"></script>
<script type="text/javascript" src="/mongo-csharp-driver/2.11/js/scripts.js"></script>
<script type="text/javascript" src="/mongo-csharp-driver/2.11/lib/bootstrap-toggle/bootstrap-toggle.min.js"></script>
<script type="text/javascript" src="/mongo-csharp-driver/2.11/js/dn.js"></script>


<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-K75Z5Q"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push(
{'gtm.start': new Date().getTime(),event:'gtm.js'}
);var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-K75Z5Q');</script>


<script type="text/javascript">
var _elqQ = _elqQ || [];
_elqQ.push(['elqSetSiteId', '413370795']);
_elqQ.push(['elqTrackPageView']);
(function () {
function async_load()
{ var s = document.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = '//img03.en25.com/i/elqCfg.min.js'; var x = document.getElementsByTagName('script')[0]; x.parentNode.insertBefore(s, x); }
if (window.addEventListener) window.addEventListener('DOMContentLoaded', async_load, false);
else if (window.attachEvent) window.attachEvent('onload', async_load);
})();
</script>

</body>
</html>

