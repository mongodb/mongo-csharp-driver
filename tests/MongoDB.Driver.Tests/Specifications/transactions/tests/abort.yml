database_name: &database_name "transaction-tests"
collection_name: &collection_name "test"

data: []

tests:
  - description: abort

    operations:
      - name: startTransaction
        arguments:
          session: session0
      - name: insertOne
        arguments:
          document:
            _id: 1
          session: session0
        result:
          insertedId: 1
      - name: abortTransaction
        arguments:
          session: session0
      - name: startTransaction
        arguments:
          session: session0
      - name: insertOne
        arguments:
          document:
            _id: 1
          session: session0
        result:
          insertedId: 1
      - name: abortTransaction
        arguments:
          session: session0

    expectations:
      - command_started_event:
          command:
            insert: *collection_name
            documents:
              - _id: 1
            ordered: true
            readConcern:
            lsid: session0
            txnNumber:
               $numberLong: "1"
            startTransaction: true
            autocommit: false
            writeConcern:
          command_name: insert
          database_name: *database_name
      - command_started_event:
          command:
            abortTransaction: 1
            lsid: session0
            txnNumber:
              "$numberLong": "1"
            startTransaction:
            autocommit: false
            writeConcern:
          command_name: abortTransaction
          database_name: admin
      - command_started_event:
          command:
            insert: *collection_name
            documents:
              - _id: 1
            ordered: true
            readConcern:
              afterClusterTime: 42
            lsid: session0
            txnNumber:
              $numberLong: "2"
            startTransaction: true
            autocommit: false
            writeConcern:
          command_name: insert
          database_name: *database_name
      - command_started_event:
          command:
            abortTransaction: 1
            lsid: session0
            txnNumber:
              $numberLong: "2"
            startTransaction:
            autocommit: false
            writeConcern:
          command_name: abortTransaction
          database_name: admin

    outcome:
      collection:
        data: []

  - description: implicit abort

    operations:
      # Start a transaction but don't commit - the driver calls abortTransaction
      # from ClientSession.endSession().
      - name: startTransaction
        arguments:
          session: session0
      - name: insertOne
        arguments:
          document:
            _id: 1
          session: session0
        result:
          insertedId: 1

    expectations:
      - command_started_event:
          command:
            insert: *collection_name
            documents:
              - _id: 1
            ordered: true
            readConcern:
            lsid: session0
            txnNumber:
              $numberLong: "1"
            startTransaction: true
            autocommit: false
            writeConcern:
          command_name: insert
          database_name: *database_name
      - command_started_event:
          command:
            abortTransaction: 1
            lsid: session0
            txnNumber:
              $numberLong: "1"
            startTransaction:
            autocommit: false
            writeConcern:
          command_name: abortTransaction
          database_name: admin

    outcome:
      collection:
        data: []

  - description: two aborts

    operations:
      - name: startTransaction
        arguments:
          session: session0
      - name: insertOne
        arguments:
          document:
            _id: 1
          session: session0
        result:
          insertedId: 1
      - name: abortTransaction
        arguments:
          session: session0
      - name: abortTransaction
        arguments:
          session: session0
        result:
          errorContains: no transaction started

    expectations:
      - command_started_event:
          command:
            insert: *collection_name
            documents:
              - _id: 1
            ordered: true
            readConcern:
            lsid: session0
            txnNumber:
              $numberLong: "1"
            startTransaction: true
            autocommit: false
            writeConcern:
          command_name: insert
          database_name: *database_name
      - command_started_event:
          command:
            abortTransaction: 1
            lsid: session0
            txnNumber:
              $numberLong: "1"
            startTransaction:
            autocommit: false
            writeConcern:
          command_name: abortTransaction
          database_name: admin

    outcome:
      collection:
        data: []

  - description: abort without start

    operations:
      - name: abortTransaction
        arguments:
          session: session0
        result:
          errorContains: no transaction started

    expectations: []

    outcome:
      collection:
        data: []

  - description: commit after abort

    operations:
      - name: startTransaction
        arguments:
          session: session0
      - name: insertOne
        arguments:
          document:
            _id: 1
          session: session0
        result:
          insertedId: 1
      - name: abortTransaction
        arguments:
          session: session0
      - name: commitTransaction
        arguments:
          session: session0
        result:
          errorContains: no transaction started

    expectations:
      - command_started_event:
          command:
            insert: *collection_name
            documents:
              - _id: 1
            ordered: true
            readConcern:
            lsid: session0
            txnNumber:
               $numberLong: "1"
            startTransaction: true
            autocommit: false
            writeConcern:
          command_name: insert
          database_name: *database_name
      - command_started_event:
          command:
            abortTransaction: 1
            lsid: session0
            txnNumber:
              $numberLong: "1"
            startTransaction:
            autocommit: false
            writeConcern:
          command_name: abortTransaction
          database_name: admin

  - description: abort ignores TransactionAborted

    operations:
      - name: startTransaction
        arguments:
          session: session0
      - name: insertOne
        arguments:
          document:
            _id: 1
          session: session0
        result:
          insertedId: 1
      # Abort the server transaction with a duplicate key error.
      - name: insertOne
        arguments:
          document:
            _id: 1
          session: session0
        result:
          errorCodeName: DuplicateKey
      # Make sure the server aborted the transaction.
      - name: insertOne
        arguments:
          document:
            _id: 1
          session: session0
        result:
          errorCodeName: NoSuchTransaction
      # abortTransaction must ignore the TransactionAborted and succeed.
      - name: abortTransaction
        arguments:
          session: session0

    expectations:
      - command_started_event:
          command:
            insert: *collection_name
            documents:
              - _id: 1
            ordered: true
            readConcern:
            lsid: session0
            txnNumber:
               $numberLong: "1"
            startTransaction: true
            autocommit: false
            writeConcern:
          command_name: insert
          database_name: *database_name
      - command_started_event:
          command:
            insert: *collection_name
            documents:
              - _id: 1
            ordered: true
            readConcern:
            lsid: session0
            txnNumber:
               $numberLong: "1"
            startTransaction:
            autocommit: false
            writeConcern:
          command_name: insert
          database_name: *database_name
      - command_started_event:
          command:
            insert: *collection_name
            documents:
              - _id: 1
            ordered: true
            readConcern:
            lsid: session0
            txnNumber:
               $numberLong: "1"
            startTransaction:
            autocommit: false
            writeConcern:
          command_name: insert
          database_name: *database_name
      - command_started_event:
          command:
            abortTransaction: 1
            lsid: session0
            txnNumber:
              $numberLong: "1"
            startTransaction:
            autocommit: false
            writeConcern:
          command_name: abortTransaction
          database_name: admin


    outcome:
      collection:
        data: []

  - description: abort does not apply writeConcern

    operations:
      - name: startTransaction
        arguments:
          session: session0
          options:
            writeConcern:
              w: 10
      - name: insertOne
        arguments:
          document:
            _id: 1
          session: session0
        result:
          insertedId: 1
      - name: abortTransaction
        arguments:
          session: session0
        # No CannotSatisfyWriteConcern error.

    outcome:
      collection:
        data: []
